{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/app/api/chat/route.ts"],"sourcesContent":["import OpenAI from 'openai';\nimport { NextRequest, NextResponse } from 'next/server';\nimport { neon } from '@neondatabase/serverless';\n\n// Models currently allowed for chat (override with OPENAI_CHAT_MODEL env)\nconst ALLOWED_OPENAI_CHAT_MODELS = [\n  'gpt-4o',\n  'gpt-4o-mini',\n  'gpt-4-turbo',\n  'gpt-4',\n  'gpt-4o-2024-11-20',\n  'gpt-4o-mini-2024-07-18',\n  'gpt-3.5-turbo',\n] as const;\n\nfunction getModel(): string {\n  const envModel = process.env.OPENAI_CHAT_MODEL?.trim();\n  if (envModel && ALLOWED_OPENAI_CHAT_MODELS.includes(envModel as (typeof ALLOWED_OPENAI_CHAT_MODELS)[number])) {\n    return envModel;\n  }\n  return 'gpt-4o-mini'; // default when OPENAI_CHAT_MODEL is unset or not in allowed list\n}\n\nconst systemPrompt = `You are a live AI Revenue Advisor for Convivia24. You help visitors with revenue, sales, and pipeline questions. Be concise, professional, and helpful. Collect their name and email when relevant so the team can follow up. Treat this as a live chat: short turns, clear next steps.`;\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { messages = [], inquiryId: providedId, name, email, subject } = body as {\n      messages?: { role: 'user' | 'assistant'; content: string }[];\n      inquiryId?: string;\n      name?: string;\n      email?: string;\n      subject?: string;\n    };\n\n    if (!Array.isArray(messages) || messages.length === 0) {\n      return NextResponse.json({ error: 'messages array required with at least one message' }, { status: 400 });\n    }\n\n    if (!process.env.OPENAI_API_KEY) {\n      return NextResponse.json({ error: 'Chat is not configured (missing OPENAI_API_KEY)' }, { status: 503 });\n    }\n\n    const model = getModel();\n    const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\n    const dbUrl = process.env.DATABASE_URL;\n    let inquiryId = providedId as string | null;\n\n    if (dbUrl) {\n      const sql = neon(dbUrl);\n      if (!inquiryId) {\n        const rows = await sql`\n          INSERT INTO chat_inquiries (name, email, subject, messages, status)\n          VALUES (${name ?? null}, ${email ?? null}, ${subject ?? null}, '[]', 'open')\n          RETURNING id\n        `;\n        inquiryId = rows?.[0]?.id ?? null;\n      }\n    }\n\n    const apiMessages: OpenAI.Chat.Completions.ChatCompletionMessageParam[] = [\n      { role: 'system', content: systemPrompt },\n      ...messages.map((m: { role: string; content: string }) => ({\n        role: m.role === 'assistant' ? 'assistant' as const : 'user' as const,\n        content: m.content,\n      })),\n    ];\n\n    const stream = await openai.chat.completions.create({\n      model,\n      messages: apiMessages,\n      max_tokens: 1024,\n      stream: true,\n    });\n\n    const encoder = new TextEncoder();\n    let fullContent = '';\n\n    const readable = new ReadableStream({\n      async start(controller) {\n        try {\n          for await (const chunk of stream) {\n            const text = chunk.choices[0]?.delta?.content;\n            if (text) {\n              fullContent += text;\n              controller.enqueue(encoder.encode(text));\n            }\n          }\n          if (dbUrl && inquiryId) {\n            const sql = neon(dbUrl);\n            const updatedMessages = [\n              ...messages,\n              { role: 'assistant' as const, content: fullContent },\n            ];\n            await sql`\n              UPDATE chat_inquiries\n              SET messages = ${JSON.stringify(updatedMessages)}::jsonb,\n                  \"updatedAt\" = NOW()\n              WHERE id = ${inquiryId}::uuid\n            `;\n          }\n          controller.enqueue(encoder.encode(`\\n\\x00DATA:${JSON.stringify({ done: true, inquiryId })}\\n`));\n        } catch (e) {\n          controller.error(e);\n        } finally {\n          controller.close();\n        }\n      },\n    });\n\n    return new NextResponse(readable, {\n      headers: {\n        'Content-Type': 'text/plain; charset=utf-8',\n        'Cache-Control': 'no-cache',\n        Connection: 'keep-alive',\n      },\n    });\n  } catch (err) {\n    console.error('Chat API error:', err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : 'Chat request failed' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AACA;;;;AAEA,0EAA0E;AAC1E,MAAM,6BAA6B;IACjC;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,SAAS;IACP,MAAM,WAAW,QAAQ,GAAG,CAAC,iBAAiB,EAAE;IAChD,IAAI,YAAY,2BAA2B,QAAQ,CAAC,WAA0D;QAC5G,OAAO;IACT;IACA,OAAO,eAAe,iEAAiE;AACzF;AAEA,MAAM,eAAe,CAAC,uRAAuR,CAAC;AAEvS,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,WAAW,EAAE,EAAE,WAAW,UAAU,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG;QAQvE,IAAI,CAAC,MAAM,OAAO,CAAC,aAAa,SAAS,MAAM,KAAK,GAAG;YACrD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoD,GAAG;gBAAE,QAAQ;YAAI;QACzG;QAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,EAAE;YAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkD,GAAG;gBAAE,QAAQ;YAAI;QACvG;QAEA,MAAM,QAAQ;QACd,MAAM,SAAS,IAAI,mLAAM,CAAC;YAAE,QAAQ,QAAQ,GAAG,CAAC,cAAc;QAAC;QAE/D,MAAM,QAAQ,QAAQ,GAAG,CAAC,YAAY;QACtC,IAAI,YAAY;QAEhB,IAAI,OAAO;YACT,MAAM,MAAM,IAAA,gKAAI,EAAC;YACjB,IAAI,CAAC,WAAW;gBACd,MAAM,OAAO,MAAM,GAAG,CAAC;;kBAEb,EAAE,QAAQ,KAAK,EAAE,EAAE,SAAS,KAAK,EAAE,EAAE,WAAW,KAAK;;QAE/D,CAAC;gBACD,YAAY,MAAM,CAAC,EAAE,EAAE,MAAM;YAC/B;QACF;QAEA,MAAM,cAAoE;YACxE;gBAAE,MAAM;gBAAU,SAAS;YAAa;eACrC,SAAS,GAAG,CAAC,CAAC,IAAyC,CAAC;oBACzD,MAAM,EAAE,IAAI,KAAK,cAAc,cAAuB;oBACtD,SAAS,EAAE,OAAO;gBACpB,CAAC;SACF;QAED,MAAM,SAAS,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YAClD;YACA,UAAU;YACV,YAAY;YACZ,QAAQ;QACV;QAEA,MAAM,UAAU,IAAI;QACpB,IAAI,cAAc;QAElB,MAAM,WAAW,IAAI,eAAe;YAClC,MAAM,OAAM,UAAU;gBACpB,IAAI;oBACF,WAAW,MAAM,SAAS,OAAQ;wBAChC,MAAM,OAAO,MAAM,OAAO,CAAC,EAAE,EAAE,OAAO;wBACtC,IAAI,MAAM;4BACR,eAAe;4BACf,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC;wBACpC;oBACF;oBACA,IAAI,SAAS,WAAW;wBACtB,MAAM,MAAM,IAAA,gKAAI,EAAC;wBACjB,MAAM,kBAAkB;+BACnB;4BACH;gCAAE,MAAM;gCAAsB,SAAS;4BAAY;yBACpD;wBACD,MAAM,GAAG,CAAC;;6BAEO,EAAE,KAAK,SAAS,CAAC,iBAAiB;;yBAEtC,EAAE,UAAU;YACzB,CAAC;oBACH;oBACA,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC,CAAC,WAAW,EAAE,KAAK,SAAS,CAAC;wBAAE,MAAM;wBAAM;oBAAU,GAAG,EAAE,CAAC;gBAC/F,EAAE,OAAO,GAAG;oBACV,WAAW,KAAK,CAAC;gBACnB,SAAU;oBACR,WAAW,KAAK;gBAClB;YACF;QACF;QAEA,OAAO,IAAI,gJAAY,CAAC,UAAU;YAChC,SAAS;gBACP,gBAAgB;gBAChB,iBAAiB;gBACjB,YAAY;YACd;QACF;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;QAAsB,GACpE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}