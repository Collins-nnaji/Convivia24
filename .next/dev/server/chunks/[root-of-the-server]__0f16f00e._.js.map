{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/auth/server.ts"],"sourcesContent":["import { createNeonAuth } from '@neondatabase/auth/next/server';\n\nexport function getAuth() {\n  return createNeonAuth({\n    baseUrl: process.env.NEON_AUTH_BASE_URL!,\n    cookies: {\n      secret: process.env.NEON_AUTH_COOKIE_SECRET!,\n    },\n  });\n}\n\n// Normalize Neon's { data, error } so session?.user works everywhere (dashboard, API routes)\nasync function getSessionNormalized() {\n  const { data } = await getAuth().getSession();\n  const user = data?.user ?? (data as any)?.session?.user;\n  if (!user) return null;\n  return { ...data, user } as { user: { id: string; email?: string | null; name?: string | null; image?: string | null }; [k: string]: unknown };\n}\n\n// Convenience alias â€” call getAuth() in request handlers, not at module level\nexport const auth = {\n  getSession: getSessionNormalized,\n  handler: () => getAuth().handler(),\n  middleware: (config?: { loginUrl?: string }) => getAuth().middleware(config),\n};\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,SAAS;IACd,OAAO,IAAA,8LAAc,EAAC;QACpB,SAAS,QAAQ,GAAG,CAAC,kBAAkB;QACvC,SAAS;YACP,QAAQ,QAAQ,GAAG,CAAC,uBAAuB;QAC7C;IACF;AACF;AAEA,6FAA6F;AAC7F,eAAe;IACb,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,UAAU,UAAU;IAC3C,MAAM,OAAO,MAAM,QAAS,MAAc,SAAS;IACnD,IAAI,CAAC,MAAM,OAAO;IAClB,OAAO;QAAE,GAAG,IAAI;QAAE;IAAK;AACzB;AAGO,MAAM,OAAO;IAClB,YAAY;IACZ,SAAS,IAAM,UAAU,OAAO;IAChC,YAAY,CAAC,SAAmC,UAAU,UAAU,CAAC;AACvE"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/db/index.ts"],"sourcesContent":["import { neon, type NeonQueryFunction } from '@neondatabase/serverless';\n\nlet _sql: NeonQueryFunction<false, false> | null = null;\n\nfunction getSql() {\n  if (!_sql) _sql = neon(process.env.DATABASE_URL!);\n  return _sql;\n}\n\n// Export a real function so Turbopack/bundler treats it as callable (Proxy can break in server bundle).\n// Return type ensures destructuring (e.g. const [row] = await sql`...`) type-checks.\nfunction sql(strings: TemplateStringsArray, ...values: unknown[]): Promise<Record<string, unknown>[]> {\n  return (getSql() as (strings: TemplateStringsArray, ...values: unknown[]) => Promise<Record<string, unknown>[]>)(strings, ...values);\n}\n\nexport default sql;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,OAA+C;AAEnD,SAAS;IACP,IAAI,CAAC,MAAM,OAAO,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;IAC/C,OAAO;AACT;AAEA,wGAAwG;AACxG,qFAAqF;AACrF,SAAS,IAAI,OAA6B,EAAE,GAAG,MAAiB;IAC9D,OAAO,AAAC,SAAyG,YAAY;AAC/H;uCAEe"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/auth/session.ts"],"sourcesContent":["import { auth } from './server';\nimport type { AppUser } from './access';\nimport sql from '@/lib/db';\nimport { redirect } from 'next/navigation';\n\n/** Only these emails get admin role on login. Single source of truth for \"who can be admin\". */\nexport const ADMIN_EMAILS = ['collinsnnaji1@gmail.com', 'speak2tojo@gmail.com'] as const;\n\nconst ADMIN_EMAILS_LOWER = ADMIN_EMAILS.map((e) => e.toLowerCase());\n\nexport function isAdmin(email: string | null | undefined): boolean {\n  return !!email && ADMIN_EMAILS_LOWER.includes(email.toLowerCase().trim());\n}\n\nexport async function getSession() {\n  return auth.getSession();\n}\n\nexport async function requireAuth() {\n  const session = await auth.getSession();\n  if (!session?.user) redirect('/auth/sign-in');\n  return session.user;\n}\n\n/** Use app_users.role (synced from ADMIN_EMAILS on login) so DB is source of truth for access */\nexport async function requireAdmin() {\n  const user = await requireAuth();\n  const appUser = await getAppUser({ id: user.id, email: user.email!, name: user.name, image: user.image });\n  if (appUser.role !== 'admin') redirect('/dashboard?admin=denied');\n  return user;\n}\n\n/** Upsert Neon Auth user into app_users; role is kept in sync with ADMIN_EMAILS on every login. Email stored lowercase. */\nexport async function syncUser(authUser: { id: string; email: string; name?: string | null; image?: string | null }): Promise<AppUser> {\n  const emailNorm = (authUser.email ?? '').toLowerCase().trim();\n  const role = isAdmin(authUser.email) ? 'admin' : 'client';\n  const rows = await sql`\n    INSERT INTO app_users (id, email, name, image, role)\n    VALUES (${authUser.id}, ${emailNorm}, ${authUser.name ?? null}, ${authUser.image ?? null}, ${role})\n    ON CONFLICT (email) DO UPDATE\n      SET name  = EXCLUDED.name,\n          image = EXCLUDED.image,\n          id    = EXCLUDED.id,\n          role  = EXCLUDED.role\n    RETURNING *\n  `;\n  return rows[0] as AppUser;\n}\n\n/** Get app_user row, syncing from auth if needed. Ensures ADMIN_EMAILS users always have role=admin (self-heal). */\nexport async function getAppUser(authUser: { id: string; email: string; name?: string | null; image?: string | null }): Promise<AppUser> {\n  const emailNorm = (authUser.email ?? '').toLowerCase().trim();\n  if (!emailNorm) return syncUser(authUser);\n  // Case-insensitive lookup so session email (e.g. \"User@Email.com\") matches DB (\"user@email.com\")\n  const rows = await sql`\n    SELECT * FROM app_users WHERE LOWER(TRIM(email)) = ${emailNorm}\n  `;\n  if (rows.length === 0) return syncUser(authUser);\n  const row = rows[0] as AppUser;\n  if (isAdmin(authUser.email) && row.role !== 'admin') {\n    await sql`UPDATE app_users SET role = 'admin' WHERE id = ${row.id}`;\n    const updated = await sql`SELECT * FROM app_users WHERE id = ${row.id}`;\n    return updated[0] as AppUser;\n  }\n  return row;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;AAEA;AACA;AAAA;;;;AAGO,MAAM,eAAe;IAAC;IAA2B;CAAuB;AAE/E,MAAM,qBAAqB,aAAa,GAAG,CAAC,CAAC,IAAM,EAAE,WAAW;AAEzD,SAAS,QAAQ,KAAgC;IACtD,OAAO,CAAC,CAAC,SAAS,mBAAmB,QAAQ,CAAC,MAAM,WAAW,GAAG,IAAI;AACxE;AAEO,eAAe;IACpB,OAAO,+HAAI,CAAC,UAAU;AACxB;AAEO,eAAe;IACpB,MAAM,UAAU,MAAM,+HAAI,CAAC,UAAU;IACrC,IAAI,CAAC,SAAS,MAAM,IAAA,mMAAQ,EAAC;IAC7B,OAAO,QAAQ,IAAI;AACrB;AAGO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,MAAM,UAAU,MAAM,WAAW;QAAE,IAAI,KAAK,EAAE;QAAE,OAAO,KAAK,KAAK;QAAG,MAAM,KAAK,IAAI;QAAE,OAAO,KAAK,KAAK;IAAC;IACvG,IAAI,QAAQ,IAAI,KAAK,SAAS,IAAA,mMAAQ,EAAC;IACvC,OAAO;AACT;AAGO,eAAe,SAAS,QAAoF;IACjH,MAAM,YAAY,CAAC,SAAS,KAAK,IAAI,EAAE,EAAE,WAAW,GAAG,IAAI;IAC3D,MAAM,OAAO,QAAQ,SAAS,KAAK,IAAI,UAAU;IACjD,MAAM,OAAO,MAAM,+HAAG,CAAC;;YAEb,EAAE,SAAS,EAAE,CAAC,EAAE,EAAE,UAAU,EAAE,EAAE,SAAS,IAAI,IAAI,KAAK,EAAE,EAAE,SAAS,KAAK,IAAI,KAAK,EAAE,EAAE,KAAK;;;;;;;EAOpG,CAAC;IACD,OAAO,IAAI,CAAC,EAAE;AAChB;AAGO,eAAe,WAAW,QAAoF;IACnH,MAAM,YAAY,CAAC,SAAS,KAAK,IAAI,EAAE,EAAE,WAAW,GAAG,IAAI;IAC3D,IAAI,CAAC,WAAW,OAAO,SAAS;IAChC,iGAAiG;IACjG,MAAM,OAAO,MAAM,+HAAG,CAAC;uDAC8B,EAAE,UAAU;EACjE,CAAC;IACD,IAAI,KAAK,MAAM,KAAK,GAAG,OAAO,SAAS;IACvC,MAAM,MAAM,IAAI,CAAC,EAAE;IACnB,IAAI,QAAQ,SAAS,KAAK,KAAK,IAAI,IAAI,KAAK,SAAS;QACnD,MAAM,+HAAG,CAAC,+CAA+C,EAAE,IAAI,EAAE,CAAC,CAAC;QACnE,MAAM,UAAU,MAAM,+HAAG,CAAC,mCAAmC,EAAE,IAAI,EAAE,CAAC,CAAC;QACvE,OAAO,OAAO,CAAC,EAAE;IACnB;IACA,OAAO;AACT"}},
    {"offset": {"line": 193, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/auth/access.ts"],"sourcesContent":["/**\n * Access control for the platform. Scales by using app_users.role as source of truth.\n *\n * - Admin: only users with role 'admin' (set from ADMIN_EMAILS on login via syncUser).\n * - Client: everyone else; access scoped by client_users (which client they belong to).\n *\n * To add more admins: add email to ADMIN_EMAILS in lib/auth/session.ts and have that\n * user log in once (syncUser sets role). Later you can add \"promote to admin\" by\n * updating app_users.role in the DB.\n */\n\nexport type AppUser = { id: string; email: string; name?: string | null; image?: string | null; role: string };\n\nexport function canAccessAdmin(appUser: AppUser | null | undefined): boolean {\n  return appUser?.role === 'admin';\n}\n\nexport function canAccessDashboard(appUser: AppUser | null | undefined): boolean {\n  return !!appUser;\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;CASC;;;;;;AAIM,SAAS,eAAe,OAAmC;IAChE,OAAO,SAAS,SAAS;AAC3B;AAEO,SAAS,mBAAmB,OAAmC;IACpE,OAAO,CAAC,CAAC;AACX"}},
    {"offset": {"line": 218, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/app/api/listings/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { auth } from '@/lib/auth/server';\nimport { getAppUser } from '@/lib/auth/session';\nimport { canAccessAdmin } from '@/lib/auth/access';\nimport sql from '@/lib/db';\n\nasync function getClientForUser(userId: string): Promise<string | null> {\n  const rows = await sql`\n    SELECT c.id FROM clients c\n    JOIN client_users cu ON cu.client_id = c.id\n    WHERE cu.user_id = ${userId}\n    LIMIT 1\n  `;\n  const row = rows[0];\n  return row ? String(row.id) : null;\n}\n\nexport async function GET(req: NextRequest) {\n  const session = await auth.getSession();\n  if (!session?.user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  const appUser = await getAppUser({\n    id: session.user.id,\n    email: session.user.email!,\n    name: session.user.name,\n    image: session.user.image,\n  });\n\n  if (canAccessAdmin(appUser)) {\n    const { searchParams } = new URL(req.url);\n    const clientId = searchParams.get('client_id');\n    const status = searchParams.get('status');\n    let rows: Record<string, unknown>[];\n    if (clientId && status) {\n      rows = (await sql`\n        SELECT l.*, c.name as client_name\n        FROM listings l\n        JOIN clients c ON c.id = l.client_id\n        WHERE l.client_id = ${clientId} AND l.status = ${status}\n        ORDER BY l.updated_at DESC\n      `) as Record<string, unknown>[];\n    } else if (clientId) {\n      rows = (await sql`\n        SELECT l.*, c.name as client_name\n        FROM listings l\n        JOIN clients c ON c.id = l.client_id\n        WHERE l.client_id = ${clientId}\n        ORDER BY l.updated_at DESC\n      `) as Record<string, unknown>[];\n    } else if (status) {\n      rows = (await sql`\n        SELECT l.*, c.name as client_name\n        FROM listings l\n        JOIN clients c ON c.id = l.client_id\n        WHERE l.status = ${status}\n        ORDER BY l.updated_at DESC\n      `) as Record<string, unknown>[];\n    } else {\n      rows = (await sql`\n        SELECT l.*, c.name as client_name\n        FROM listings l\n        JOIN clients c ON c.id = l.client_id\n        ORDER BY l.updated_at DESC\n      `) as Record<string, unknown>[];\n    }\n    return NextResponse.json(rows);\n  }\n\n  const clientId = await getClientForUser(appUser.id);\n  if (!clientId) return NextResponse.json([]);\n\n  const rows = await sql`\n    SELECT * FROM listings\n    WHERE client_id = ${clientId}\n    ORDER BY updated_at DESC\n  `;\n  return NextResponse.json(rows as Record<string, unknown>[]);\n}\n\nexport async function POST(req: NextRequest) {\n  const session = await auth.getSession();\n  if (!session?.user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  const appUser = await getAppUser({\n    id: session.user.id,\n    email: session.user.email!,\n    name: session.user.name,\n    image: session.user.image,\n  });\n\n  if (canAccessAdmin(appUser)) {\n    return NextResponse.json({ error: 'Use dashboard to add listings as a client' }, { status: 403 });\n  }\n\n  const clientId = await getClientForUser(appUser.id);\n  if (!clientId) {\n    return NextResponse.json(\n      { error: 'Your account is not linked to a client. Contact support.' },\n      { status: 400 }\n    );\n  }\n\n  const body = await req.json();\n  const title = body.title?.trim();\n  if (!title) return NextResponse.json({ error: 'Title is required' }, { status: 400 });\n\n  const description = body.description?.trim() ?? null;\n  const asking_price = body.asking_price != null ? Number(body.asking_price) : null;\n  const currency = body.currency?.trim() || 'GBP';\n  const commission_pct = body.commission_pct != null ? Number(body.commission_pct) : null;\n\n  const [row] = await sql`\n    INSERT INTO listings (client_id, title, description, asking_price, currency, commission_pct, status)\n    VALUES (${clientId}, ${title}, ${description}, ${asking_price}, ${currency}, ${commission_pct}, 'draft')\n    RETURNING *\n  `;\n  return NextResponse.json(row, { status: 201 });\n}\n"],"names":[],"mappings":"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"}}]
}