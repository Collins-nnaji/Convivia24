{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/db.js"],"sourcesContent":["import { neon } from '@neondatabase/serverless';\n\n// Handle missing DATABASE_URL gracefully for build time\nconst databaseUrl = process.env.DATABASE_URL || process.env.POSTGRES_URL || '';\nexport const sql = databaseUrl ? neon(databaseUrl) : null;\n\n/**\n * Execute a query with error handling\n */\nexport async function query(text, params) {\n  if (!sql) {\n    throw new Error('Database connection not configured. Please set DATABASE_URL environment variable.');\n  }\n  try {\n    const result = await sql(text, params);\n    return result;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n}\n\n/**\n * Execute a transaction\n */\nexport async function transaction(callback) {\n  if (!sql) {\n    throw new Error('Database connection not configured. Please set DATABASE_URL environment variable.');\n  }\n  try {\n    const result = await callback(sql);\n    return result;\n  } catch (error) {\n    console.error('Transaction error:', error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,wDAAwD;AACxD,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY,IAAI,QAAQ,GAAG,CAAC,YAAY,IAAI;AACrE,MAAM,MAAM,cAAc,IAAA,gKAAI,EAAC,eAAe;AAK9C,eAAe,MAAM,IAAI,EAAE,MAAM;IACtC,IAAI,CAAC,KAAK;QACR,MAAM,IAAI,MAAM;IAClB;IACA,IAAI;QACF,MAAM,SAAS,MAAM,IAAI,MAAM;QAC/B,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAKO,eAAe,YAAY,QAAQ;IACxC,IAAI,CAAC,KAAK;QACR,MAAM,IAAI,MAAM;IAClB;IACA,IAAI;QACF,MAAM,SAAS,MAAM,SAAS;QAC9B,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,MAAM;IACR;AACF"}},
    {"offset": {"line": 111, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/auth.js"],"sourcesContent":["import jwt from 'jsonwebtoken';\nimport bcrypt from 'bcryptjs';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';\nconst JWT_EXPIRE = process.env.JWT_EXPIRE || '30d';\n\n/**\n * Hash a password\n */\nexport async function hashPassword(password) {\n  const salt = await bcrypt.genSalt(10);\n  return bcrypt.hash(password, salt);\n}\n\n/**\n * Compare password with hash\n */\nexport async function comparePassword(password, hash) {\n  return bcrypt.compare(password, hash);\n}\n\n/**\n * Generate JWT token\n */\nexport function generateToken(payload) {\n  return jwt.sign(payload, JWT_SECRET, {\n    expiresIn: JWT_EXPIRE,\n  });\n}\n\n/**\n * Verify JWT token\n */\nexport function verifyToken(token) {\n  try {\n    return jwt.verify(token, JWT_SECRET);\n  } catch (error) {\n    return null;\n  }\n}\n\n/**\n * Get token from request headers\n */\nexport function getTokenFromRequest(request) {\n  const authHeader = request.headers.get('authorization');\n  if (authHeader && authHeader.startsWith('Bearer ')) {\n    return authHeader.substring(7);\n  }\n  return null;\n}\n\n/**\n * Middleware to verify authentication\n */\nexport async function authenticate(request) {\n  // DEVELOPMENT MODE: Allow access without authentication\n  const DEV_MODE = process.env.NODE_ENV === 'development' || true; // Allow dev mode for now\n  \n  if (DEV_MODE) {\n    // Return a mock admin user for development\n    return { \n      user: {\n        id: 'dev-user-id',\n        email: 'dev@convivia24.com',\n        role: 'admin',\n        business_id: null,\n      }, \n      error: null \n    };\n  }\n\n  const token = getTokenFromRequest(request);\n  \n  if (!token) {\n    return { error: 'No token provided', status: 401 };\n  }\n\n  const decoded = verifyToken(token);\n  if (!decoded) {\n    return { error: 'Invalid token', status: 401 };\n  }\n\n  return { user: decoded, error: null };\n}\n\n/**\n * Middleware factory for role-based access control\n */\nexport function requireRole(...allowedRoles) {\n  return async (request) => {\n    const authResult = await authenticate(request);\n    \n    if (authResult.error) {\n      return authResult;\n    }\n\n    const user = authResult.user;\n    \n    if (!allowedRoles.includes(user.role)) {\n      return { \n        error: `Access denied. Required roles: ${allowedRoles.join(', ')}`, \n        status: 403 \n      };\n    }\n\n    return { user, error: null };\n  };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;AACA;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAKtC,eAAe,aAAa,QAAQ;IACzC,MAAM,OAAO,MAAM,8IAAM,CAAC,OAAO,CAAC;IAClC,OAAO,8IAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAKO,eAAe,gBAAgB,QAAQ,EAAE,IAAI;IAClD,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAKO,SAAS,cAAc,OAAO;IACnC,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QACnC,WAAW;IACb;AACF;AAKO,SAAS,YAAY,KAAK;IAC/B,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAKO,SAAS,oBAAoB,OAAO;IACzC,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,cAAc,WAAW,UAAU,CAAC,YAAY;QAClD,OAAO,WAAW,SAAS,CAAC;IAC9B;IACA,OAAO;AACT;AAKO,eAAe,aAAa,OAAO;IACxC,wDAAwD;IACxD,MAAM,WAAW,oDAAyB,iBAAiB,MAAM,yBAAyB;IAE1F,wCAAc;QACZ,2CAA2C;QAC3C,OAAO;YACL,MAAM;gBACJ,IAAI;gBACJ,OAAO;gBACP,MAAM;gBACN,aAAa;YACf;YACA,OAAO;QACT;IACF;;;IAEA,MAAM;IAMN,MAAM;AAMR;AAKO,SAAS,YAAY,GAAG,YAAY;IACzC,OAAO,OAAO;QACZ,MAAM,aAAa,MAAM,aAAa;QAEtC,IAAI,WAAW,KAAK,EAAE;YACpB,OAAO;QACT;QAEA,MAAM,OAAO,WAAW,IAAI;QAE5B,IAAI,CAAC,aAAa,QAAQ,CAAC,KAAK,IAAI,GAAG;YACrC,OAAO;gBACL,OAAO,CAAC,+BAA+B,EAAE,aAAa,IAAI,CAAC,OAAO;gBAClE,QAAQ;YACV;QACF;QAEA,OAAO;YAAE;YAAM,OAAO;QAAK;IAC7B;AACF"}},
    {"offset": {"line": 202, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/app/api/invoices/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { sql } from '@/lib/db';\nimport { authenticate } from '@/lib/auth';\n\n// GET invoices (role-based filtering)\nexport async function GET(request) {\n  try {\n    const authResult = await authenticate(request);\n\n    if (authResult.error) {\n      return NextResponse.json(\n        { error: authResult.error },\n        { status: authResult.status }\n      );\n    }\n\n    const { user } = authResult;\n    const { searchParams } = new URL(request.url);\n    const status = searchParams.get('status');\n    const business_id = searchParams.get('business_id');\n\n    // Check if database is available\n    if (!sql) {\n      // Return mock invoice data\n      const mockInvoices = [\n        {\n          id: 'mock-invoice-1',\n          booking_id: 'mock-3',\n          business_id: 'mock-business-3',\n          invoice_number: 'INV-2024-001',\n          amount: 50000,\n          tax: 3750,\n          total: 53750,\n          due_date: new Date(Date.now() + 2592000000).toISOString().split('T')[0],\n          status: 'paid',\n          paid_at: new Date(Date.now() - 172800000).toISOString(),\n          booking_status: 'completed',\n          service_name: 'Deep Cleaning & Sanitation Reset',\n          business_name: 'Finance Hub Ltd',\n          created_at: new Date(Date.now() - 259200000).toISOString(),\n        },\n        {\n          id: 'mock-invoice-2',\n          booking_id: 'mock-1',\n          business_id: 'mock-business-1',\n          invoice_number: 'INV-2024-002',\n          amount: 15000,\n          tax: 1125,\n          total: 16125,\n          due_date: new Date(Date.now() + 2592000000).toISOString().split('T')[0],\n          status: 'sent',\n          paid_at: null,\n          booking_status: 'pending',\n          service_name: 'Routine Commercial Cleaning',\n          business_name: 'TechCorp Nigeria',\n          created_at: new Date().toISOString(),\n        },\n      ];\n\n      let filteredInvoices = mockInvoices;\n      if (user.role === 'client') {\n        filteredInvoices = filteredInvoices.filter(i => i.business_id === user.business_id);\n      }\n      if (status && status !== 'all') {\n        filteredInvoices = filteredInvoices.filter(i => i.status === status);\n      }\n\n      return NextResponse.json({ invoices: filteredInvoices });\n    }\n\n    let query;\n\n    if (user.role === 'admin') {\n      query = sql`\n        SELECT \n          i.*,\n          b.id as booking_id,\n          b.status as booking_status,\n          b.service_id,\n          bs.name as business_name,\n          s.name as service_name\n        FROM invoices i\n        LEFT JOIN bookings b ON i.booking_id = b.id\n        LEFT JOIN businesses bs ON i.business_id = bs.id\n        LEFT JOIN services s ON b.service_id = s.id\n        WHERE 1=1\n        ${status ? sql`AND i.status = ${status}` : sql``}\n        ${business_id ? sql`AND i.business_id = ${business_id}` : sql``}\n        ORDER BY i.created_at DESC\n        LIMIT 100\n      `;\n    } else if (user.role === 'client') {\n      query = sql`\n        SELECT \n          i.*,\n          b.id as booking_id,\n          b.status as booking_status,\n          b.service_id,\n          bs.name as business_name,\n          s.name as service_name\n        FROM invoices i\n        LEFT JOIN bookings b ON i.booking_id = b.id\n        LEFT JOIN businesses bs ON i.business_id = bs.id\n        LEFT JOIN services s ON b.service_id = s.id\n        WHERE i.business_id = ${user.business_id}\n        ${status ? sql`AND i.status = ${status}` : sql``}\n        ORDER BY i.created_at DESC\n      `;\n    } else {\n      return NextResponse.json(\n        { error: 'Unauthorized' },\n        { status: 403 }\n      );\n    }\n\n    const invoices = await query;\n\n    return NextResponse.json({ invoices });\n  } catch (error) {\n    console.error('Get invoices error:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch invoices' },\n      { status: 500 }\n    );\n  }\n}\n\n// PATCH update invoice status (admin only, for marking as paid)\nexport async function PATCH(request) {\n  try {\n    const authResult = await authenticate(request);\n\n    if (authResult.error || authResult.user?.role !== 'admin') {\n      return NextResponse.json(\n        { error: 'Unauthorized. Admin access required.' },\n        { status: 403 }\n      );\n    }\n\n    const body = await request.json();\n    const { id, status, paid_at } = body;\n\n    if (!id || !status) {\n      return NextResponse.json(\n        { error: 'Invoice ID and status are required' },\n        { status: 400 }\n      );\n    }\n\n    const [invoice] = await sql`\n      UPDATE invoices\n      SET \n        status = ${status},\n        paid_at = ${status === 'paid' ? (paid_at || new Date().toISOString()) : null},\n        updated_at = CURRENT_TIMESTAMP\n      WHERE id = ${id}\n      RETURNING *\n    `;\n\n    if (!invoice) {\n      return NextResponse.json(\n        { error: 'Invoice not found' },\n        { status: 404 }\n      );\n    }\n\n    return NextResponse.json({ invoice });\n  } catch (error) {\n    console.error('Update invoice error:', error);\n    return NextResponse.json(\n      { error: 'Failed to update invoice' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}