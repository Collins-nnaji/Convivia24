{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/auth/server.ts"],"sourcesContent":["import { createNeonAuth } from '@neondatabase/auth/next/server';\n\nexport function getAuth() {\n  return createNeonAuth({\n    baseUrl: process.env.NEON_AUTH_BASE_URL!,\n    cookies: {\n      secret: process.env.NEON_AUTH_COOKIE_SECRET!,\n    },\n  });\n}\n\n// Normalize Neon's { data, error } so session?.user works everywhere (dashboard, API routes)\nasync function getSessionNormalized() {\n  const { data } = await getAuth().getSession();\n  const user = data?.user ?? (data as any)?.session?.user;\n  if (!user) return null;\n  return { ...data, user } as { user: { id: string; email?: string | null; name?: string | null; image?: string | null }; [k: string]: unknown };\n}\n\n// Convenience alias â€” call getAuth() in request handlers, not at module level\nexport const auth = {\n  getSession: getSessionNormalized,\n  handler: () => getAuth().handler(),\n  middleware: (config?: { loginUrl?: string }) => getAuth().middleware(config),\n};\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,SAAS;IACd,OAAO,IAAA,8LAAc,EAAC;QACpB,SAAS,QAAQ,GAAG,CAAC,kBAAkB;QACvC,SAAS;YACP,QAAQ,QAAQ,GAAG,CAAC,uBAAuB;QAC7C;IACF;AACF;AAEA,6FAA6F;AAC7F,eAAe;IACb,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,UAAU,UAAU;IAC3C,MAAM,OAAO,MAAM,QAAS,MAAc,SAAS;IACnD,IAAI,CAAC,MAAM,OAAO;IAClB,OAAO;QAAE,GAAG,IAAI;QAAE;IAAK;AACzB;AAGO,MAAM,OAAO;IAClB,YAAY;IACZ,SAAS,IAAM,UAAU,OAAO;IAChC,YAAY,CAAC,SAAmC,UAAU,UAAU,CAAC;AACvE"}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/db/index.ts"],"sourcesContent":["import { neon, type NeonQueryFunction } from '@neondatabase/serverless';\n\nlet _sql: NeonQueryFunction<false, false> | null = null;\n\nfunction getSql() {\n  if (!_sql) _sql = neon(process.env.DATABASE_URL!);\n  return _sql;\n}\n\n// Export a real function so Turbopack/bundler treats it as callable (Proxy can break in server bundle)\nfunction sql(strings: TemplateStringsArray, ...values: unknown[]) {\n  return (getSql() as (...args: unknown[]) => unknown)(strings, ...values);\n}\n\nexport default sql;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,OAA+C;AAEnD,SAAS;IACP,IAAI,CAAC,MAAM,OAAO,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;IAC/C,OAAO;AACT;AAEA,uGAAuG;AACvG,SAAS,IAAI,OAA6B,EAAE,GAAG,MAAiB;IAC9D,OAAO,AAAC,SAA6C,YAAY;AACnE;uCAEe"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/lib/auth/session.ts"],"sourcesContent":["import { auth } from './server';\nimport sql from '@/lib/db';\nimport { redirect } from 'next/navigation';\n\nconst ADMIN_EMAILS = ['collinsnnaji1@gmail.com', 'speak2tojo@gmail.com'];\n\nexport async function getSession() {\n  return auth.getSession();\n}\n\nexport async function requireAuth() {\n  const session = await auth.getSession();\n  if (!session?.user) redirect('/auth/sign-in');\n  return session.user;\n}\n\nexport async function requireAdmin() {\n  const user = await requireAuth();\n  if (!ADMIN_EMAILS.includes(user.email ?? '')) redirect('/dashboard');\n  return user;\n}\n\n/** Upsert Neon Auth user into app_users and return their row */\nexport async function syncUser(authUser: { id: string; email: string; name?: string | null; image?: string | null }) {\n  const role = ADMIN_EMAILS.includes(authUser.email) ? 'admin' : 'client';\n  const rows = await sql`\n    INSERT INTO app_users (id, email, name, image, role)\n    VALUES (${authUser.id}, ${authUser.email}, ${authUser.name ?? null}, ${authUser.image ?? null}, ${role})\n    ON CONFLICT (email) DO UPDATE\n      SET name  = EXCLUDED.name,\n          image = EXCLUDED.image,\n          id    = EXCLUDED.id\n    RETURNING *\n  `;\n  return rows[0];\n}\n\n/** Get app_user row, syncing from auth if needed */\nexport async function getAppUser(authUser: { id: string; email: string; name?: string | null; image?: string | null }) {\n  const rows = await sql`SELECT * FROM app_users WHERE email = ${authUser.email}`;\n  if (rows.length) return rows[0];\n  return syncUser(authUser);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AACA;AAAA;;;;AAEA,MAAM,eAAe;IAAC;IAA2B;CAAuB;AAEjE,eAAe;IACpB,OAAO,+HAAI,CAAC,UAAU;AACxB;AAEO,eAAe;IACpB,MAAM,UAAU,MAAM,+HAAI,CAAC,UAAU;IACrC,IAAI,CAAC,SAAS,MAAM,IAAA,mMAAQ,EAAC;IAC7B,OAAO,QAAQ,IAAI;AACrB;AAEO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,IAAI,CAAC,aAAa,QAAQ,CAAC,KAAK,KAAK,IAAI,KAAK,IAAA,mMAAQ,EAAC;IACvD,OAAO;AACT;AAGO,eAAe,SAAS,QAAoF;IACjH,MAAM,OAAO,aAAa,QAAQ,CAAC,SAAS,KAAK,IAAI,UAAU;IAC/D,MAAM,OAAO,MAAM,+HAAG,CAAC;;YAEb,EAAE,SAAS,EAAE,CAAC,EAAE,EAAE,SAAS,KAAK,CAAC,EAAE,EAAE,SAAS,IAAI,IAAI,KAAK,EAAE,EAAE,SAAS,KAAK,IAAI,KAAK,EAAE,EAAE,KAAK;;;;;;EAMzG,CAAC;IACD,OAAO,IAAI,CAAC,EAAE;AAChB;AAGO,eAAe,WAAW,QAAoF;IACnH,MAAM,OAAO,MAAM,+HAAG,CAAC,sCAAsC,EAAE,SAAS,KAAK,CAAC,CAAC;IAC/E,IAAI,KAAK,MAAM,EAAE,OAAO,IAAI,CAAC,EAAE;IAC/B,OAAO,SAAS;AAClB"}},
    {"offset": {"line": 165, "column": 0}, "map": {"version":3,"sources":["file:///Users/collinsnnaji/VSCodeDevelopments/convivia24/app/api/documents/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { auth } from '@/lib/auth/server';\nimport { getAppUser } from '@/lib/auth/session';\nimport sql from '@/lib/db';\n\nconst IDRIVE_ENDPOINT = process.env.IDRIVE_ENDPOINT ?? '';\nconst IDRIVE_BUCKET = process.env.IDRIVE_BUCKET ?? '';\n\nasync function getClientForUser(userId: string) {\n  const rows = await sql`\n    SELECT c.id FROM clients c\n    JOIN client_users cu ON cu.client_id = c.id\n    WHERE cu.user_id = ${userId}\n    LIMIT 1\n  `;\n  return rows[0]?.id ?? null;\n}\n\nexport async function GET() {\n  const session = await auth.getSession();\n  if (!session?.user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  const appUser = await getAppUser({ id: session.user.id, email: session.user.email!, name: session.user.name, image: session.user.image });\n\n  const clientId = await getClientForUser(appUser.id);\n  if (!clientId) return NextResponse.json([]);\n\n  const docs = await sql`SELECT * FROM documents WHERE client_id = ${clientId} ORDER BY created_at DESC`;\n  return NextResponse.json(docs);\n}\n\nexport async function POST(req: NextRequest) {\n  const session = await auth.getSession();\n  if (!session?.user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  const appUser = await getAppUser({ id: session.user.id, email: session.user.email!, name: session.user.name, image: session.user.image });\n\n  const { name, key, size, type, clientId: adminClientId } = await req.json();\n\n  let clientId: string | null;\n  if (appUser.role === 'admin') {\n    clientId = adminClientId ?? null;\n  } else {\n    clientId = await getClientForUser(appUser.id);\n  }\n  if (!clientId) {\n    return NextResponse.json(\n      { error: 'Your account is not linked to a client. Contact support to get access to document uploads.' },\n      { status: 400 }\n    );\n  }\n\n  if (!IDRIVE_ENDPOINT || !IDRIVE_BUCKET) {\n    return NextResponse.json(\n      { error: 'Storage not configured (IDRIVE_ENDPOINT / IDRIVE_BUCKET).' },\n      { status: 503 }\n    );\n  }\n\n  const url = `https://${IDRIVE_ENDPOINT}/${IDRIVE_BUCKET}/${key}`;\n\n  const [doc] = await sql`\n    INSERT INTO documents (client_id, uploaded_by, name, idrive_key, url, size_bytes, mime_type)\n    VALUES (${clientId}, ${appUser.id}, ${name}, ${key}, ${url}, ${size}, ${type})\n    RETURNING *\n  `;\n  return NextResponse.json(doc, { status: 201 });\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,kBAAkB,QAAQ,GAAG,CAAC,eAAe,IAAI;AACvD,MAAM,gBAAgB,QAAQ,GAAG,CAAC,aAAa,IAAI;AAEnD,eAAe,iBAAiB,MAAc;IAC5C,MAAM,OAAO,MAAM,+HAAG,CAAC;;;uBAGF,EAAE,OAAO;;EAE9B,CAAC;IACD,OAAO,IAAI,CAAC,EAAE,EAAE,MAAM;AACxB;AAEO,eAAe;IACpB,MAAM,UAAU,MAAM,+HAAI,CAAC,UAAU;IACrC,IAAI,CAAC,SAAS,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAe,GAAG;QAAE,QAAQ;IAAI;IACtF,MAAM,UAAU,MAAM,IAAA,sIAAU,EAAC;QAAE,IAAI,QAAQ,IAAI,CAAC,EAAE;QAAE,OAAO,QAAQ,IAAI,CAAC,KAAK;QAAG,MAAM,QAAQ,IAAI,CAAC,IAAI;QAAE,OAAO,QAAQ,IAAI,CAAC,KAAK;IAAC;IAEvI,MAAM,WAAW,MAAM,iBAAiB,QAAQ,EAAE;IAClD,IAAI,CAAC,UAAU,OAAO,gJAAY,CAAC,IAAI,CAAC,EAAE;IAE1C,MAAM,OAAO,MAAM,+HAAG,CAAC,0CAA0C,EAAE,SAAS,yBAAyB,CAAC;IACtG,OAAO,gJAAY,CAAC,IAAI,CAAC;AAC3B;AAEO,eAAe,KAAK,GAAgB;IACzC,MAAM,UAAU,MAAM,+HAAI,CAAC,UAAU;IACrC,IAAI,CAAC,SAAS,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAe,GAAG;QAAE,QAAQ;IAAI;IACtF,MAAM,UAAU,MAAM,IAAA,sIAAU,EAAC;QAAE,IAAI,QAAQ,IAAI,CAAC,EAAE;QAAE,OAAO,QAAQ,IAAI,CAAC,KAAK;QAAG,MAAM,QAAQ,IAAI,CAAC,IAAI;QAAE,OAAO,QAAQ,IAAI,CAAC,KAAK;IAAC;IAEvI,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAE,IAAI,EAAE,UAAU,aAAa,EAAE,GAAG,MAAM,IAAI,IAAI;IAEzE,IAAI;IACJ,IAAI,QAAQ,IAAI,KAAK,SAAS;QAC5B,WAAW,iBAAiB;IAC9B,OAAO;QACL,WAAW,MAAM,iBAAiB,QAAQ,EAAE;IAC9C;IACA,IAAI,CAAC,UAAU;QACb,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA6F,GACtG;YAAE,QAAQ;QAAI;IAElB;IAEA,IAAI,CAAC,mBAAmB,CAAC,eAAe;QACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA4D,GACrE;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,MAAM,CAAC,QAAQ,EAAE,gBAAgB,CAAC,EAAE,cAAc,CAAC,EAAE,KAAK;IAEhE,MAAM,CAAC,IAAI,GAAG,MAAM,+HAAG,CAAC;;YAEd,EAAE,SAAS,EAAE,EAAE,QAAQ,EAAE,CAAC,EAAE,EAAE,KAAK,EAAE,EAAE,IAAI,EAAE,EAAE,IAAI,EAAE,EAAE,KAAK,EAAE,EAAE,KAAK;;EAE/E,CAAC;IACD,OAAO,gJAAY,CAAC,IAAI,CAAC,KAAK;QAAE,QAAQ;IAAI;AAC9C"}}]
}